// RippleVMS - Prisma Schema
// Phase 1: Volunteer onboarding, training, availability, and shift management

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  VOLUNTEER
  COORDINATOR
  DISPATCHER
  ADMINISTRATOR
  DEVELOPER
}

enum ShiftType {
  PATROL
  COLLECTION
  ON_CALL_FIELD_SUPPORT
}

enum ShiftStatus {
  DRAFT
  PUBLISHED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum RSVPStatus {
  PENDING
  CONFIRMED
  DECLINED
  NO_SHOW
}

enum TrainingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

// Shift qualifications - what positions a user can fill during shifts
// Earned through training completion or manually assigned by admins
enum Qualification {
  VERIFIER      // Can verify people at patrols
  ZONE_LEAD     // Can lead a zone during a shift
  DISPATCHER    // Can handle dispatch calls
}

// ICE Sighting report statuses (workflow stage)
enum SightingStatus {
  NEW        // Reserved for future public submissions
  REVIEWING  // Dispatcher entered, working on it
  DISPATCHED // Field team sent out
  CLOSED     // Resolved (check disposition for outcome)
}

// ICE Sighting disposition (outcome - separate from status)
enum SightingDisposition {
  CONFIRMED   // ICE activity verified
  UNVERIFIED  // Unable to confirm or deny
  FALSE_ALARM // Not ICE / mistaken report
}

// Media types for sighting uploads
enum MediaType {
  IMAGE
  VIDEO
}

// Email blast templates
enum EmailTemplate {
  GENERAL_NEWSLETTER
  SCHEDULE_ANNOUNCEMENT
  TRAINING_ANNOUNCEMENT
  FREEFORM
}

// Email blast status
enum EmailBlastStatus {
  PENDING
  SENDING
  COMPLETED
  FAILED
}

// Individual email send status
enum EmailSendStatus {
  PENDING
  SENT
  FAILED
}

// Account approval status for volunteer signup workflow
enum AccountStatus {
  PENDING   // Application submitted, awaiting review
  APPROVED  // Approved by coordinator/admin
  REJECTED  // Application rejected
}

// ============================================
// QUALIFIED ROLES (Admin-configurable shift positions)
// ============================================

model QualifiedRole {
  id                    String   @id @default(cuid())
  name                  String   @unique  // "Verifier", "Zone Lead", "Dispatcher"
  slug                  String   @unique  // "VERIFIER", "ZONE_LEAD", "DISPATCHER"
  description           String?
  color                 String   @default("#6366f1")  // Indigo by default

  isActive              Boolean  @default(true)
  isDefaultForNewUsers  Boolean  @default(false)  // Auto-assign to new users
  countsTowardMinimum   Boolean  @default(true)   // If false, volunteers with this role don't count toward shift min/max
  sortOrder             Int      @default(0)

  // Relations
  userQualifications    UserQualification[]
  shiftTypeRequirements ShiftTypeQualifiedRoleRequirement[]
  trainingTypeGrants    TrainingType[] @relation("TrainingGrantsQualifiedRole")
  shiftVolunteers       ShiftVolunteer[]
  trainingModuleGrants  TrainingModule[] @relation("ModuleGrantsQualifiedRole")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Junction table for User qualified roles
model UserQualification {
  id                String        @id @default(cuid())
  userId            String
  qualifiedRoleId   String

  // Track how the qualification was earned
  earnedAt          DateTime      @default(now())
  expiresAt         DateTime?
  grantedById       String?       // Admin who granted it manually
  trainingSessionId String?       // Training session that granted it

  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  qualifiedRole     QualifiedRole @relation(fields: [qualifiedRoleId], references: [id], onDelete: Cascade)

  @@unique([userId, qualifiedRoleId])
  @@index([userId])
  @@index([qualifiedRoleId])
}

// ============================================
// ORGANIZATION SETTINGS
// ============================================

model OrganizationSettings {
  id              String   @id @default(cuid())

  // Branding Settings (configurable by admin)
  orgName          String   @default("RippleVMS")      // Organization name used in emails
  emailFromName    String   @default("RippleVMS")      // "From" name in emails
  emailFromAddress String   @default("")               // Email address for sending (e.g., noreply@example.com)
  emailReplyTo     String   @default("")               // Reply-to email address (where replies go)
  emailFooter      String   @default("RippleVMS Team") // Footer text in emails

  // RSVP Settings
  autoConfirmRsvp Boolean  @default(false)  // If true, RSVPs are immediately confirmed

  // Future settings
  timezone        String   @default("America/New_York")

  // Upload settings for ICE sighting reports
  maxUploadSizeMb     Int  @default(50)   // Max file size in MB
  maxUploadsPerReport Int  @default(5)    // Max number of files per report

  // Feature flag overrides (null = use env var default)
  featureTrainings  Boolean?  // Override for NEXT_PUBLIC_FEATURE_TRAININGS
  featureSightings  Boolean?  // Override for NEXT_PUBLIC_FEATURE_SIGHTINGS

  // Dispatcher scheduling mode
  // REGIONAL = one dispatcher covers all counties per time block (low activity)
  // COUNTY = one dispatcher per county per time block (medium activity)
  // ZONE = dispatcher per time block cell (high activity - current default)
  dispatcherSchedulingMode  String  @default("ZONE")

  // Volunteer scheduling mode
  // SIMPLE = Only show Regional Lead, Dispatcher, Zone Lead (hide volunteer counts and restrict shift visibility)
  // FULL = Show all volunteers with self-signup
  schedulingMode            String  @default("SIMPLE")

  // Developer-only settings
  feedbackEmail     String?   // Email address for receiving user feedback (Developer configurable)

  // Email digest settings
  weeklyDigestEnabled  Boolean  @default(false)  // Send weekly schedule digest email on Sundays
  weeklyDigestSendHour Int      @default(18)     // Hour to send (0-23 in ET), default 6 PM

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// SHIFT TYPE CONFIGURATION
// ============================================

model ShiftTypeConfig {
  id              String   @id @default(cuid())
  name            String   @unique  // "Patrol", "Collection", "Court Watch"
  slug            String   @unique  // "PATROL", "COLLECTION" - for compatibility/API use
  description     String?
  color           String   @default("#3b82f6")  // Hex color for UI display

  // Default volunteer requirements
  defaultMinVolunteers   Int @default(2)
  defaultIdealVolunteers Int @default(4)
  defaultMaxVolunteers   Int @default(6)

  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  // Relationships
  qualificationRequirements ShiftTypeQualificationRequirement[]  // DEPRECATED
  qualifiedRoleRequirements ShiftTypeQualifiedRoleRequirement[] @relation("ShiftTypeQualifiedRoleReqs")  // NEW
  shifts          Shift[]  @relation("ShiftTypeConfig")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// DEPRECATED: Use ShiftTypeQualifiedRoleRequirement instead
model ShiftTypeQualificationRequirement {
  id              String          @id @default(cuid())
  shiftTypeId     String
  shiftType       ShiftTypeConfig @relation(fields: [shiftTypeId], references: [id], onDelete: Cascade)
  qualification   Qualification   // VERIFIER, ZONE_LEAD, DISPATCHER
  minRequired     Int             @default(0)
  maxAllowed      Int?            // null = unlimited

  @@unique([shiftTypeId, qualification])
}

// NEW: Qualified Role requirements for shift types
model ShiftTypeQualifiedRoleRequirement {
  id              String          @id @default(cuid())
  shiftTypeId     String
  qualifiedRoleId String

  shiftType       ShiftTypeConfig @relation("ShiftTypeQualifiedRoleReqs", fields: [shiftTypeId], references: [id], onDelete: Cascade)
  qualifiedRole   QualifiedRole   @relation(fields: [qualifiedRoleId], references: [id], onDelete: Cascade)

  minRequired     Int             @default(0)
  maxAllowed      Int?            // null = unlimited

  @@unique([shiftTypeId, qualifiedRoleId])
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String
  phone             String?
  signalHandle      String?   // Signal username/handle for coordination
  role              Role      @default(VOLUNTEER)
  profileImageUrl   String?

  // DEPRECATED: Use qualifications instead (kept for migration)
  qualifiedRoles    Role[]

  // Shift qualifications - positions this user can fill during shifts
  // Earned through training completion or manually assigned by admins
  // New users start with empty array (cannot sign up for shifts until trained)
  qualifications    Qualification[]

  // Volunteer-specific fields
  primaryLanguage   String    @default("English")
  otherLanguages    String[]
  emergencyContact  String?
  emergencyPhone    String?
  backgroundCheckDate DateTime?
  backgroundCheckStatus String?

  // Status
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)

  // Email preferences
  emailNotifications Boolean  @default(true)  // Can opt out of non-critical emails
  unsubscribeToken   String?  @unique         // Token for one-click unsubscribe

  // Authentication
  passwordHash        String?               // Hashed password (bcryptjs)
  passwordSetAt       DateTime?             // When password was last set
  resetToken          String?   @unique     // Password reset token (UUID)
  resetTokenExpiresAt DateTime?             // Token expiration time
  lastLoginAt         DateTime?             // Last successful login timestamp

  // Account approval workflow (volunteer signup)
  accountStatus       AccountStatus @default(APPROVED)  // APPROVED for existing users
  applicationDate     DateTime?             // When signup form was submitted
  approvedById        String?               // Coordinator/Admin who approved
  approvedBy          User?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedUsers       User[]    @relation("ApprovedBy")  // Users this person approved
  approvedAt          DateTime?             // When account was approved
  rejectionReason     String?               // Optional reason if rejected
  intakeResponses     Json?                 // Flexible JSON for intake form answers

  // Relationships
  zones             UserZone[]
  trainings         UserTraining[]
  availability      Availability[]
  shiftVolunteers   ShiftVolunteer[]
  createdShifts     Shift[]   @relation("CreatedBy")
  trainingAttendances     TrainingSessionAttendee[]
  createdTrainingSessions TrainingSession[] @relation("TrainingCreatedBy")
  dispatcherAssignments   DispatcherAssignment[]

  // Qualified roles (new system - positions user can fill during shifts)
  userQualifications    UserQualification[]

  // Training Center enrollments
  moduleEnrollments     ModuleEnrollment[]

  // Email blast relationships
  sentEmailBlasts      EmailBlast[]          @relation("EmailBlastSentBy")
  receivedEmailBlasts  EmailBlastRecipient[] @relation("EmailBlastRecipients")

  // POI relationships
  createdPOIs          PointOfInterest[]     @relation("POICreatedBy")

  // Regional Lead relationships
  regionalLeadAssignments        RegionalLeadAssignment[] @relation("RegionalLeadAssignments")
  regionalLeadAssignmentsCreated RegionalLeadAssignment[] @relation("RegionalLeadAssignmentsCreated")

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// ============================================
// ZONES
// ============================================

model Zone {
  id          String     @id @default(cuid())
  name        String     @unique  // e.g., "Durham 1", "Wake 3"
  county      String?    // Durham, Orange, Wake
  description String?
  signalGroup String?    // Signal group invite link
  isActive    Boolean    @default(true)

  // Map display settings
  boundaries  Json?      // Array of {lat, lng} coordinates defining the zone polygon
  color       String     @default("#3b82f6")  // Fill color (hex)
  fillOpacity Float      @default(0.3)        // 0-1 opacity
  strokeWeight Int       @default(2)          // Border width in pixels

  // Relationships
  users       UserZone[]
  shifts      Shift[]
  trainingSessions TrainingSession[]
  pois        PointOfInterest[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

// Many-to-many: Users can belong to multiple zones
model UserZone {
  id        String   @id @default(cuid())
  userId    String
  zoneId    String
  isPrimary Boolean  @default(false)

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  zone      Zone     @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, zoneId])
}

// ============================================
// TRAINING
// ============================================

model Training {
  id                String           @id @default(cuid())
  name              String
  description       String?
  duration          Int?             // Duration in minutes
  expiresAfterDays  Int?             // Number of days until training expires
  isRequired        Boolean          @default(false)
  requiredForRoles  Role[]
  requiredForShiftTypes ShiftType[]

  // Relationships
  completions       UserTraining[]

  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model UserTraining {
  id              String         @id @default(cuid())
  userId          String
  trainingId      String
  status          TrainingStatus @default(NOT_STARTED)
  completedAt     DateTime?
  expiresAt       DateTime?
  certificateUrl  String?

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  training        Training       @relation(fields: [trainingId], references: [id], onDelete: Cascade)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@unique([userId, trainingId])
}

// ============================================
// TRAINING TYPES & SESSIONS (Schedulable)
// ============================================

model TrainingType {
  id              String   @id @default(cuid())
  name            String   @unique  // "Verifier", "Zone Lead", "Dispatcher"
  slug            String   @unique  // "VERIFIER", "ZONE_LEAD", "DISPATCHER"
  description     String?
  color           String   @default("#8b5cf6")  // Purple by default

  // Training settings
  defaultDuration     Int      @default(120)  // Minutes
  defaultCapacity     Int      @default(20)
  expiresAfterDays    Int?     // Certification expiration (null = never)

  // DEPRECATED: Use grantsQualifiedRole instead
  grantsRole          Role?
  grantsQualification Qualification?  // DEPRECATED

  // NEW: Qualified role granted upon completion
  grantsQualifiedRoleId String?
  grantsQualifiedRole   QualifiedRole? @relation("TrainingGrantsQualifiedRole", fields: [grantsQualifiedRoleId], references: [id])

  isActive        Boolean  @default(true)
  sortOrder       Int      @default(0)

  // Relationships
  sessions        TrainingSession[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TrainingSession {
  id              String       @id @default(cuid())
  trainingTypeId  String
  trainingType    TrainingType @relation(fields: [trainingTypeId], references: [id])

  title           String
  description     String?

  // Timing
  date            DateTime
  startTime       DateTime
  endTime         DateTime

  // Location
  location        String?      // Physical address or "Virtual"
  meetingLink     String?      // For virtual trainings (Zoom, etc.)
  zoneId          String?      // Optional - training can be zone-specific
  zone            Zone?        @relation(fields: [zoneId], references: [id])

  // Capacity
  minAttendees    Int          @default(1)
  maxAttendees    Int          @default(20)

  // Status (reuse ShiftStatus enum)
  status          ShiftStatus  @default(DRAFT)

  // Relationships
  createdById     String
  createdBy       User         @relation("TrainingCreatedBy", fields: [createdById], references: [id])
  attendees       TrainingSessionAttendee[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model TrainingSessionAttendee {
  id              String     @id @default(cuid())
  sessionId       String
  userId          String
  status          RSVPStatus @default(PENDING)

  // Tracking
  confirmedAt     DateTime?
  attendedAt      DateTime?  // Check-in time
  completedAt     DateTime?  // Marked as completed training

  session         TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([sessionId, userId])
}

// ============================================
// AVAILABILITY
// ============================================

model Availability {
  id            String    @id @default(cuid())
  userId        String

  // Weekly recurring availability
  dayOfWeek     Int?      // 0-6 (Sunday-Saturday), null for specific dates
  startTime     String    // "09:00" format
  endTime       String    // "17:00" format

  // Specific date availability/exceptions
  specificDate  DateTime? // For one-off availability or exceptions
  isException   Boolean   @default(false) // True if this is a "not available" exception

  // Preferences
  preferredShiftTypes ShiftType[]
  notes         String?

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ============================================
// SHIFTS
// ============================================

model Shift {
  id              String      @id @default(cuid())
  type            ShiftType   // Keep for backward compatibility
  title           String
  description     String?

  // Dynamic shift type configuration (nullable for migration)
  typeConfigId    String?
  typeConfig      ShiftTypeConfig? @relation("ShiftTypeConfig", fields: [typeConfigId], references: [id])

  // Timing
  date            DateTime
  startTime       DateTime
  endTime         DateTime

  // Location
  zoneId          String
  zone            Zone        @relation(fields: [zoneId], references: [id])
  meetingLocation String?

  // Capacity
  minVolunteers   Int         @default(2)
  idealVolunteers Int         @default(4)
  maxVolunteers   Int         @default(6)

  // Requirements
  requirements    String[]    // Training/qualification IDs required

  // Status
  status          ShiftStatus @default(DRAFT)

  // Relationships
  createdById     String
  createdBy       User        @relation("CreatedBy", fields: [createdById], references: [id])
  volunteers      ShiftVolunteer[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([date, status])
  @@index([zoneId])
}

model ShiftVolunteer {
  id              String         @id @default(cuid())
  shiftId         String
  userId          String
  status          RSVPStatus     @default(PENDING)

  // DEPRECATED: The qualification/role the volunteer is signing up as
  qualification   Qualification?

  // NEW: The qualified role the volunteer is signing up as
  qualifiedRoleId String?
  qualifiedRole   QualifiedRole? @relation(fields: [qualifiedRoleId], references: [id])

  // Leadership designation
  isZoneLead      Boolean        @default(false)  // Designate this volunteer as zone lead for this shift

  // Confirmation
  confirmedAt     DateTime?
  checkedInAt     DateTime?
  checkedOutAt    DateTime?

  // Notes
  notes           String?

  shift           Shift      @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@unique([shiftId, userId])
}

// ============================================
// DISPATCHER ASSIGNMENTS
// ============================================

model DispatcherAssignment {
  id            String    @id @default(cuid())
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // County-wide coverage (Wake, Durham, Orange)
  county        String

  // Time block
  date          DateTime  // The specific date
  startTime     DateTime
  endTime       DateTime

  // Assignment details
  isBackup      Boolean   @default(false)  // Primary vs backup dispatcher
  notes         String?   // e.g., "only available until 8am"

  // Tracking
  createdById   String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, county, date, startTime])  // One assignment per user/county/time
  @@index([county, date])
}

// ============================================
// REGIONAL LEAD ASSIGNMENTS
// ============================================

model RegionalLeadAssignment {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("RegionalLeadAssignments", fields: [userId], references: [id], onDelete: Cascade)

  // Day-level assignment (no time blocks - covers entire day)
  date        DateTime @db.Date

  // Primary vs backup designation
  isPrimary   Boolean  @default(false)
  notes       String?

  // Audit
  createdById String?
  createdBy   User?    @relation("RegionalLeadAssignmentsCreated", fields: [createdById], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])  // One user can only be assigned once per day
  @@index([date])
}

// ============================================
// ICE SIGHTING REPORTS
// ============================================

model IceSighting {
  id          String   @id @default(cuid())

  // SALUTE Fields
  size        String   // S - Size/strength (e.g., "5-6 officers, 2 white SUVs")
  activity    String   // A - Actions/Activity (e.g., "trying to force a man into their SUV")
  location    String   // L - Location/Direction (free text description)
  latitude    Float?   // L - Map coordinates (optional)
  longitude   Float?   // L - Map coordinates (optional)
  uniform     String   // U - Uniform/Clothes (e.g., "blue vests with ICE on the back")
  observedAt  DateTime // T - Time & Date of sighting
  equipment   String   // E - Equipment & Weapons (e.g., "helmets, vests, and guns")

  // Reporter Info (optional - for follow-up)
  reporterName    String?
  reporterPhone   String?
  reporterEmail   String?

  // Workflow & Tracking
  status      SightingStatus @default(REVIEWING)  // Default REVIEWING for dispatcher entry
  disposition SightingDisposition?                // Outcome - set when resolved
  notes       String?        // Dispatcher notes
  assignedToId String?       // Dispatcher ID handling this

  // Relations
  media       SightingMedia[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([observedAt])
}

model SightingMedia {
  id          String   @id @default(cuid())
  sightingId  String
  sighting    IceSighting @relation(fields: [sightingId], references: [id], onDelete: Cascade)

  url         String      // Vercel Blob URL
  type        MediaType   // IMAGE or VIDEO
  filename    String      // Original filename
  size        Int         // File size in bytes

  createdAt   DateTime @default(now())

  @@index([sightingId])
}

// ============================================
// EMAIL BLASTS
// ============================================

model EmailBlast {
  id          String   @id @default(cuid())
  subject     String
  body        String   @db.Text
  template    EmailTemplate

  // Filters used (stored as JSON for audit)
  filters     Json

  // Stats
  recipientCount  Int
  sentCount       Int      @default(0)
  failedCount     Int      @default(0)

  // Sender
  sentById    String
  sentBy      User     @relation("EmailBlastSentBy", fields: [sentById], references: [id])

  status      EmailBlastStatus @default(PENDING)
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  recipients  EmailBlastRecipient[]

  @@index([status])
  @@index([sentAt])
}

model EmailBlastRecipient {
  id          String   @id @default(cuid())
  blastId     String
  blast       EmailBlast @relation(fields: [blastId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("EmailBlastRecipients", fields: [userId], references: [id])
  email       String
  status      EmailSendStatus @default(PENDING)
  sentAt      DateTime?
  error       String?

  createdAt   DateTime @default(now())

  @@unique([blastId, userId])
  @@index([blastId])
}

// ============================================
// POINTS OF INTEREST (POI)
// ============================================

model POICategory {
  id          String   @id @default(cuid())
  name        String   @unique  // "ICE/Enforcement", "Schools", "Safe Spaces"
  slug        String   @unique  // "ICE_ENFORCEMENT", "SCHOOLS", "SAFE_SPACES"
  description String?
  color       String   @default("#6366f1")  // For map markers
  icon        String?  // Optional icon name (e.g., "shield", "school", "heart")
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  pois        PointOfInterest[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PointOfInterest {
  id          String      @id @default(cuid())
  name        String      // "Stewart Detention Center", "Durham Public Library"
  description String?

  // Location
  address     String?
  latitude    Float
  longitude   Float

  // Optional contact/metadata
  phone       String?
  website     String?
  notes       String?     // Internal notes for coordinators

  // Relations
  categoryId  String
  category    POICategory @relation(fields: [categoryId], references: [id])
  zoneId      String?
  zone        Zone?       @relation(fields: [zoneId], references: [id])

  // Audit
  createdById String
  createdBy   User        @relation("POICreatedBy", fields: [createdById], references: [id])
  isActive    Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([categoryId])
  @@index([zoneId])
  @@index([isActive])
}

// ============================================
// SYSTEM MONITORING & LOGGING
// ============================================

enum LogSeverity {
  DEBUG
  INFO
  WARN
  ERROR
  CRITICAL
}

enum LogCategory {
  AUTH           // Login, logout, password reset
  EMAIL          // Email delivery (sent, failed)
  RSVP           // Shift/training signups
  SIGHTING       // ICE sighting reports
  ADMIN          // Admin actions (settings, user mgmt)
  SYSTEM         // System health, errors
  RATE_LIMIT     // Rate limit violations
  API            // API errors and performance
}

// Main system log table - stores important operational events
model SystemLog {
  id          String      @id @default(cuid())
  severity    LogSeverity
  category    LogCategory
  message     String
  metadata    Json?       // Flexible JSON for additional context

  // Context
  userId      String?     // User who triggered the event (if applicable)
  endpoint    String?     // API endpoint (if API-related)
  ipAddress   String?     // Client IP for security events

  // Performance
  durationMs  Int?        // Request duration for API calls

  createdAt   DateTime    @default(now())

  @@index([createdAt])
  @@index([severity])
  @@index([category])
  @@index([userId])
}

// Health check results for system monitoring
model HealthCheck {
  id          String    @id @default(cuid())
  service     String    // "database", "email", "redis"
  status      String    // "healthy", "degraded", "down"
  responseMs  Int       // Response time in milliseconds
  error       String?   // Error message if status != healthy
  checkedAt   DateTime  @default(now())

  @@index([checkedAt])
  @@index([service])
}

// Alert state for cooldown tracking
model AlertState {
  id              String    @id @default(cuid())
  alertType       String    @unique  // "email_failure", "db_error", etc.
  lastTriggeredAt DateTime?
  triggerCount    Int       @default(0)
  cooldownUntil   DateTime? // Don't alert again until this time

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Audit log for tracking all data changes
model AuditLog {
  id            String   @id @default(cuid())
  userId        String                        // Who made the change
  userEmail     String                        // Denormalized for display
  userName      String?                       // Denormalized for display
  entityType    String                        // "User", "Shift", "Zone", etc.
  entityId      String?                       // ID of affected record
  action        String                        // "CREATE", "UPDATE", "DELETE", "LOGIN", "LOGOUT"
  previousValue Json?    @db.JsonB            // State before change
  newValue      Json?    @db.JsonB            // State after change
  metadata      Json?    @db.JsonB            // Extra context (IP, endpoint)
  createdAt     DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([entityType])
  @@index([action])
}

// ============================================
// TRAINING CENTER (Interactive Training Modules)
// ============================================

enum SectionType {
  VIDEO
  TEXT
  QUIZ
  RESOURCE
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  MULTI_SELECT
}

enum ModuleEnrollmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

// Training Module - a complete training course
model TrainingModule {
  id              String    @id @default(cuid())
  title           String
  description     String?   @db.Text
  thumbnailUrl    String?   // S3 URL for module thumbnail
  estimatedMinutes Int      @default(30)
  isRequired      Boolean   @default(false)
  isPublished     Boolean   @default(false)
  sortOrder       Int       @default(0)

  // Optional: Grant qualification upon completion
  grantsQualifiedRoleId String?
  grantsQualifiedRole   QualifiedRole? @relation("ModuleGrantsQualifiedRole", fields: [grantsQualifiedRoleId], references: [id])

  // Relations
  sections        ModuleSection[]
  enrollments     ModuleEnrollment[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Module Section - a segment within a module (video, text, or quiz)
model ModuleSection {
  id              String      @id @default(cuid())
  moduleId        String
  module          TrainingModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  title           String
  type            SectionType
  sortOrder       Int         @default(0)

  // For VIDEO sections
  videoUrl        String?     // S3 presigned URL path
  videoDuration   Int?        // Duration in seconds

  // For TEXT sections
  textContent     String?     @db.Text  // Markdown/HTML content

  // For RESOURCE sections (downloadable files)
  resourceUrl     String?     // S3 key for the file
  resourceName    String?     // Display name for download

  // For QUIZ sections
  quiz            ModuleQuiz?

  // Progress tracking
  progress        SectionProgress[]

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([moduleId])
}

// Quiz configuration for quiz sections
model ModuleQuiz {
  id              String        @id @default(cuid())
  sectionId       String        @unique
  section         ModuleSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  passingScore    Int           @default(80)  // Percentage required to pass
  maxAttempts     Int?          // null = unlimited attempts
  shuffleQuestions Boolean      @default(false)

  // Relations
  questions       QuizQuestion[]
  attempts        QuizAttempt[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

// Individual quiz question
model QuizQuestion {
  id              String        @id @default(cuid())
  quizId          String
  quiz            ModuleQuiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)

  questionText    String        @db.Text
  type            QuestionType
  points          Int           @default(1)
  sortOrder       Int           @default(0)

  // Explanation shown after answering
  explanation     String?       @db.Text

  // Relations
  options         QuizOption[]

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([quizId])
}

// Answer options for quiz questions
model QuizOption {
  id              String        @id @default(cuid())
  questionId      String
  question        QuizQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  optionText      String
  isCorrect       Boolean       @default(false)
  sortOrder       Int           @default(0)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([questionId])
}

// User enrollment in a training module
model ModuleEnrollment {
  id              String                @id @default(cuid())
  userId          String
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId        String
  module          TrainingModule        @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  status          ModuleEnrollmentStatus @default(NOT_STARTED)
  startedAt       DateTime?
  completedAt     DateTime?
  lastAccessedAt  DateTime?

  // Progress tracking
  sectionProgress SectionProgress[]

  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@unique([userId, moduleId])
  @@index([userId])
  @@index([moduleId])
}

// Per-section progress tracking
model SectionProgress {
  id              String          @id @default(cuid())
  enrollmentId    String
  enrollment      ModuleEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  sectionId       String
  section         ModuleSection   @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  isCompleted     Boolean         @default(false)
  completedAt     DateTime?

  // For video sections - track watch progress
  videoProgress   Int?            // Percentage watched (0-100)
  lastPosition    Int?            // Last position in seconds

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([enrollmentId, sectionId])
  @@index([enrollmentId])
  @@index([sectionId])
}

// Quiz attempt history
model QuizAttempt {
  id              String        @id @default(cuid())
  quizId          String
  quiz            ModuleQuiz    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  userId          String

  score           Int           // Points earned
  maxScore        Int           // Maximum possible points
  percentage      Int           // Score as percentage
  passed          Boolean

  answers         Json          // Array of { questionId, selectedOptionIds, isCorrect }
  startedAt       DateTime
  completedAt     DateTime      @default(now())

  createdAt       DateTime      @default(now())

  @@index([quizId])
  @@index([userId])
}
